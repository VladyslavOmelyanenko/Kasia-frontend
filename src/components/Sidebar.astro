---
import { client } from "../lib/sanity";

const data = await client.fetch(`
{
  "opera": *[_type == "project" && category == "opera"]
    | order(orderRank asc, year desc, title asc){
      title,
      "slug": slug.current
    },

  "film": *[_type == "project" && category == "film"]
    | order(orderRank asc, year desc, title asc){
      title,
      "slug": slug.current
    },

  "commercials": *[_type == "project" && category == "commercials"]
    | order(orderRank asc, year desc, title asc){
      title,
      "slug": slug.current
    }
}
`);

const pathname = (Astro.url?.pathname ?? "").replace(/\/$/, "");
const parts = pathname.split("/").filter(Boolean);
const section = parts[0] ?? "";
const slug = parts[1] ?? null;

const isAboutPage = section === "about";
const isHomePage = section === "";

const activeCategory =
  section === "opera" || section === "film" || section === "commercials"
    ? section
    : null;

const isOperaOpen = activeCategory === "opera";
const isFilmOpen = activeCategory === "film";
const isCommercialsOpen = activeCategory === "commercials";

const activeSlug = slug;
---

<aside
  class={`sidebar ${isAboutPage ? "is-about" : ""} ${isHomePage ? "is-home" : ""}`}
  id="sidebar"
  data-menu="closed"
>
  <div class="topbar">
    <div class="brand">
      <a href="/" class="designer-name">Katarzyna Lewi≈Ñska</a>
      <span class="designer-title js-mobile-only">costume designer</span>
    </div>

    <button
      type="button"
      class="menu-btn"
      aria-controls="sidebar-panel"
      aria-expanded="false"
    >
      Menu
    </button>
  </div>

  <div class="panel" id="sidebar-panel">
    <div class="sidebar-item">
      <a href="/about" class={`about-link ${isAboutPage ? "is-active" : ""}`}>
        About
      </a>
    </div>

    <div class="sidebar-item">
      <nav>
        <ul class="sidebar-navigation">
          <li
            class={`nav-category has-submenu ${isOperaOpen ? "is-open" : ""}`}
          >
            <a class="category-link" href="/opera">Opera</a>
            <ul class="submenu">
              {
                data.opera.map((p) => (
                  <li>
                    <a
                      class={
                        activeCategory === "opera" && activeSlug === p.slug
                          ? "is-active"
                          : ""
                      }
                      href={`/opera/${p.slug}`}
                    >
                      {p.title}
                    </a>
                  </li>
                ))
              }
            </ul>
          </li>

          <li class={`nav-category has-submenu ${isFilmOpen ? "is-open" : ""}`}>
            <a class="category-link" href="/film">Film</a>
            <ul class="submenu">
              {
                data.film.map((p) => (
                  <li>
                    <a
                      class={
                        activeCategory === "film" && activeSlug === p.slug
                          ? "is-active"
                          : ""
                      }
                      href={`/film/${p.slug}`}
                    >
                      {p.title}
                    </a>
                  </li>
                ))
              }
            </ul>
          </li>

          <li
            class={`nav-category has-submenu ${isCommercialsOpen ? "is-open" : ""}`}
          >
            <a class="category-link" href="/commercials">Commercials</a>
            <ul class="submenu">
              {
                data.commercials.map((p) => (
                  <li>
                    <a
                      class={
                        activeCategory === "commercials" &&
                        activeSlug === p.slug
                          ? "is-active"
                          : ""
                      }
                      href={`/commercials/${p.slug}`}
                    >
                      {p.title}
                    </a>
                  </li>
                ))
              }
            </ul>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</aside>

<script is:inline>
  function initSidebarMenu() {
    const sidebar = document.getElementById("sidebar");
    if (!sidebar || sidebar.dataset.menuBound === "1") return;
    sidebar.dataset.menuBound = "1";

    const btn = sidebar.querySelector(".menu-btn");
    const panel = document.getElementById("sidebar-panel");
    if (!btn || !panel) return;

    const setOpen = (open) => {
      sidebar.dataset.menu = open ? "open" : "closed";
      btn.setAttribute("aria-expanded", open ? "true" : "false");
    };

    setOpen(false);

    btn.addEventListener("click", () => {
      setOpen(sidebar.dataset.menu !== "open");
    });

    // close when clicking a link (back to initial)
    panel.addEventListener("click", (e) => {
      if (e.target.closest("a")) setOpen(false);
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setOpen(false);
    });
  }

  document.addEventListener("DOMContentLoaded", initSidebarMenu);
  document.addEventListener("astro:after-swap", initSidebarMenu);
</script>

<style lang="scss">
  .sidebar {
    position: fixed;
    display: flex;
    z-index: 300;
    flex-direction: column;
    top: var(--page-padding);
    left: var(--page-padding);
    width: var(--sidebar-width);
    gap: var(--lh);

    --inactive: #8f8f8f;
    --black: #000;

    color: var(--black);
  }

  .panel {
    display: flex;
    flex-direction: column;
    gap: var(--lh);
  }

  .designer-name,
  .designer-title {
    display: block;
  }

  .designer-title {
    pointer-events: none;
    user-select: none;
  }

  .topbar {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 12px;
  }

  .menu-btn {
    display: none;
    border: 0;
    background: none;
    cursor: pointer;
    color: inherit;
  }

  .sidebar-navigation {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sidebar a,
  .sidebar span {
    color: inherit;
    text-decoration: none;
  }

  .submenu {
    display: none;

    a {
      padding-left: 25px;
    }
  }

  .has-submenu:hover > .submenu,
  .has-submenu.is-open > .submenu {
    display: block;
  }

  .sidebar.is-about {
    color: var(--inactive);
  }
  .sidebar.is-about .designer-name,
  .sidebar.is-about .about-link {
    color: var(--black);
  }

  /* simplified graying (desktop) */
  .sidebar:has(a:hover),
  .sidebar:has(.nav-category.is-open) {
    color: var(--inactive);
  }
  .sidebar a:hover {
    color: var(--black);
  }
  .sidebar .submenu a.is-active,
  .sidebar .nav-category.is-open > .category-link,
  .sidebar .about-link.is-active {
    color: var(--black);
  }
  .sidebar .designer-name {
    color: var(--black);
  }
  .sidebar:has(.submenu a:hover)
    .nav-category:has(.submenu a:hover)
    > .category-link {
    color: var(--black);
  }
  .sidebar .category-link:hover {
    color: var(--black);
  }

  @media (max-width: 768px) {
    .sidebar {
      top: 0;
      left: 0;
      width: 100%;
      overflow: scroll;
      padding: var(--page-padding);
      gap: 12px;
      // background: transparent;
    }
    
    .sidebar[data-menu="open"] {
      background: #fff;
      height: 100dvh;
    }

    .menu-btn {
      display: inline-flex;
      align-items: center;
      color: var(--inactive);
    }

    .sidebar[data-menu="open"] .menu-btn {
      color: var(--black);
    }

    /* show title only when open (no animation) */
    .designer-title {
      display: none;
    }
    .sidebar[data-menu="open"] .designer-title {
      display: block;
    }

    /* panel opens/closes instantly (no animation) */
    .sidebar .panel {
      display: none;
      padding-top: 12px;
    }
    .sidebar[data-menu="open"] .panel {
      display: flex;
      flex-direction: column;
      gap: var(--lh);
    }

    /* submenus visible on mobile when menu open */
    .submenu {
      display: none;

      a {
        padding-left: 16px;
      }
    }

    .sidebar[data-menu="open"] .submenu {
      display: block;
    }

    /* mobile name gray on category/project pages */
    .sidebar:not(.is-about):not(.is-home) .designer-name {
      color: var(--inactive);
    }
    .sidebar.is-home .designer-name,
    .sidebar.is-about .designer-name {
      color: var(--black);
    }
  }
</style>
