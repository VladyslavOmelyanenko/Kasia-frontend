---
import { client } from "../lib/sanity";

const data = await client.fetch(`
{
  "opera": *[_type == "project" && category == "opera"]
    | order(orderRank asc, year desc, title asc){
      title,
      "slug": slug.current
    },

  "film": *[_type == "project" && category == "film"]
    | order(orderRank asc, year desc, title asc){
      title,
      "slug": slug.current
    },

  "commercials": *[_type == "project" && category == "commercials"]
    | order(orderRank asc, year desc, title asc){
      title,
      "slug": slug.current
    }
}
`);

// pathname like: /film, /film/some-slug, /opera/some-slug, /commercials, /about
const pathname = (Astro.url?.pathname ?? "").replace(/\/$/, "");
const parts = pathname.split("/").filter(Boolean);
const section = parts[0] ?? "";
const slug = parts[1] ?? null;

const isAboutPage = section === "about";
const isHomePage = section === "";

const activeCategory =
  section === "opera" || section === "film" || section === "commercials"
    ? section
    : null;

const isOperaOpen = activeCategory === "opera";
const isFilmOpen = activeCategory === "film";
const isCommercialsOpen = activeCategory === "commercials";

const activeSlug = slug;
---

<aside class={`sidebar ${isAboutPage ? "is-about" : ""}`} id="sidebar">
  <div class="sidebar-item">
    <a href="/" class="designer-name">Katarzyna Lewińska</a>
    <span class="designer-title">costume designer</span>
  </div>

  <div class="sidebar-item">
    <a href="/about" class={`about-link ${isAboutPage ? "is-active" : ""}`}
      >About</a
    >
  </div>

  <div class="sidebar-item">
    <nav>
      <ul class="sidebar-navigation">
        <!-- OPERA -->
        <li class={`nav-category has-submenu ${isOperaOpen ? "is-open" : ""}`}>
          <a class="category-link" href="/opera">Opera</a>
          <ul class="submenu">
            {
              data.opera.map((p) => (
                <li>
                  <a
                    class={
                      activeCategory === "opera" && activeSlug === p.slug
                        ? "is-active"
                        : ""
                    }
                    href={`/opera/${p.slug}`}
                  >
                    {p.title}
                  </a>
                </li>
              ))
            }
          </ul>
        </li>

        <!-- FILM -->
        <li class={`nav-category has-submenu ${isFilmOpen ? "is-open" : ""}`}>
          <a class="category-link" href="/film">Film</a>
          <ul class="submenu">
            {
              data.film.map((p) => (
                <li>
                  <a
                    class={
                      activeCategory === "film" && activeSlug === p.slug
                        ? "is-active"
                        : ""
                    }
                    href={`/film/${p.slug}`}
                  >
                    {p.title}
                  </a>
                </li>
              ))
            }
          </ul>
        </li>

        <!-- COMMERCIALS -->
        <li
          class={`nav-category has-submenu ${isCommercialsOpen ? "is-open" : ""}`}
        >
          <a class="category-link" href="/commercials">Commercials</a>
          <ul class="submenu">
            {
              data.commercials.map((p) => (
                <li>
                  <a
                    class={
                      activeCategory === "commercials" && activeSlug === p.slug
                        ? "is-active"
                        : ""
                    }
                    href={`/commercials/${p.slug}`}
                  >
                    {p.title}
                  </a>
                </li>
              ))
            }
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</aside>

<style lang="scss">
  @import "../styles/variables";

  .sidebar {
    position: fixed;
    display: flex;
    z-index: 300;
    flex-direction: column;
    top: $page-padding;
    left: $page-padding;
    width: $sidebar-width; /* your 200px */
    gap: $lh;

    --outer-dark: #8f8f8f;
    --outer-light: #cfcfcf;
    --black: #000;

    color: var(--black);
  }

  .designer-name,
  .designer-title {
    display: block;
  }

  /* (1) designer-title follows outer-link color, but is not interactive */
  .designer-title {
    pointer-events: none;
    user-select: none;
  }

  .sidebar-navigation {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sidebar a,
  .sidebar span {
    color: inherit;
    transition: color 0.15s ease;
    text-decoration: none;
  }

  .submenu {
    display: none;

    a {
      padding-left: 25px;
    }
  }

  /* open submenu on hover OR when current category is open */
  .has-submenu:hover > .submenu,
  .has-submenu.is-open > .submenu {
    display: block;
  }

  /* -------------------------------------------
     ABOUT PAGE: only name + about black, rest gray
     ------------------------------------------- */
  .sidebar.is-about {
    color: var(--outer-dark);
  }

  .sidebar.is-about .designer-name,
  .sidebar.is-about .about-link {
    color: var(--black);
  }

  /* -------------------------------------------
     ACTIVE (no hover): dim others, keep only active bits black
     ------------------------------------------- */
  .sidebar:has(.nav-category.is-open) {
    color: var(--outer-dark);
  }

  /* active category title black */
  .sidebar:has(.nav-category.is-open) .nav-category.is-open > .category-link {
    color: var(--black);
  }

  /* only active project black */
  .sidebar:has(.nav-category.is-open) .submenu a.is-active {
    color: var(--black);
  }

  /* -------------------------------------------
   ACTIVE PROJECT (no hover): mimic submenu-hover lightening
   ------------------------------------------- */
  .sidebar:has(.submenu a.is-active):not(:has(a:hover)) {
    color: var(--outer-light);
  }

  /* keep the active category block darker (like hover does) */
  .sidebar:has(.submenu a.is-active):not(:has(a:hover))
    .nav-category:has(.submenu a.is-active) {
    color: var(--outer-dark);
  }

  /* don’t force the active category title to black in this mode */
  .sidebar:has(.submenu a.is-active):not(:has(a:hover))
    .nav-category:has(.submenu a.is-active)
    > .category-link {
    color: inherit;
  }

  /* active project stays black */
  .sidebar:has(.submenu a.is-active):not(:has(a:hover)) .submenu a.is-active {
    color: var(--black);
  }

  /* -------------------------------------------
     HOVER priority: only ONE black thing at a time
     ------------------------------------------- */

  /* dim ONLY when hovering a LINK */
  .sidebar:has(a:hover) {
    color: var(--outer-dark);
  }

  /* hovering a submenu link makes the "outside" even lighter */
  .sidebar:has(.submenu a:hover) {
    color: var(--outer-light);
  }

  .sidebar:has(.submenu a:hover)
    .nav-category:has(.submenu a:hover)
    > .category-link,
  .sidebar:has(.submenu a:hover) .nav-category.is-open > .category-link {
    color: inherit; /* hovered category stays outer-dark; active one becomes dim */
  }

  /* keep the hovered category block dark when hovering one of its submenu links */
  .sidebar:has(.submenu a:hover) .nav-category:has(.submenu a:hover) {
    color: var(--outer-dark);
  }

  /* hovered link is the only black */
  .sidebar a:hover {
    color: var(--black);
  }

  /* (2) hover wins: remove "active black" while hovering, but keep submenu open via .is-open */
  .sidebar:has(a:hover) .nav-category.is-open > .category-link {
    color: inherit;
  }
  .sidebar:has(a:hover) .submenu a.is-active {
    color: inherit;
  }

  /* IMPORTANT CHANGE:
     Removed the rule that turned name/about gray while hovering on the About page,
     so they stay black on /about. */
</style>
