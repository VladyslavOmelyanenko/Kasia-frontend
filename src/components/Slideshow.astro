---
/**
 * Expect `images` items like:
 * {
 *   asset: { _ref: ... },
 *   alt?: string,
 *   project?: { category: string, slug: string }   // resolved in GROQ via project->
 * }
 */
const { images = [], urlFor, interval = 4000 } = Astro.props;

const slides = (images ?? [])
  .filter((img) => img?.asset?._ref)
  .map((img) => {
    const href =
      img?.project?.category && img?.project?.slug
        ? `/${img.project.category}/${img.project.slug}`
        : null;

    return {
      src: urlFor(img).auto("format").url(),
      alt: img?.alt ?? "",
      href,
    };
  });
---

<div class="slideshow" data-interval={interval}>
  <div class="slides">
    {
      slides.map((s, i) => (
        <a
          class={`slide-hit ${i === 0 ? "is-active" : ""} ${s.href ? "" : "is-disabled"}`}
          href={s.href ?? "#"}
          aria-disabled={s.href ? undefined : "true"}
          tabindex={s.href ? undefined : "-1"}
        >
          <img
            class="slide-img"
            src={s.src}
            alt={s.alt}
            loading={i === 0 ? "eager" : "lazy"}
            decoding="async"
          />
        </a>
      ))
    }
  </div>
</div>

<style lang="scss">
  .slideshow {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .slides {
    position: relative;
    width: 100%;
    height: 100%;
    aspect-ratio: 16 / 9;
  }

  /* The clickable layer that fades in/out */
  .slide-hit {
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 600ms ease;
    pointer-events: none;
    display: block;
  }

  .slide-hit.is-active {
    opacity: 1;
    pointer-events: auto;
  }

  /* If no link, don't allow clicks */
  .slide-hit.is-disabled {
    pointer-events: none;
    cursor: default;
  }

  .slide-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  @media (max-width: 768px) {
    .slides {
      aspect-ratio: auto;
    }

    .slide-img {
      object-fit: contain;
    }
  }
</style>

<script is:inline>
  function initSlideshows() {
    document.querySelectorAll(".slideshow").forEach((root) => {
      // prevent double init (important with Astro view transitions)
      if (root.dataset.bound === "1") return;
      root.dataset.bound = "1";

      const slides = Array.from(root.querySelectorAll(".slide-hit"));
      if (slides.length <= 1) return;

      const interval = Number(root.dataset.interval) || 4000;
      let index = 0;
      let timer = null;

      const show = (i) => {
        slides[index].classList.remove("is-active");
        index = (i + slides.length) % slides.length;
        slides[index].classList.add("is-active");
      };

      const start = () => {
        stop();
        timer = setInterval(() => show(index + 1), interval);
      };

      const stop = () => {
        if (timer) clearInterval(timer);
        timer = null;
      };

      start();
    });
  }

  document.addEventListener("DOMContentLoaded", initSlideshows);
  document.addEventListener("astro:after-swap", initSlideshows);
</script>
