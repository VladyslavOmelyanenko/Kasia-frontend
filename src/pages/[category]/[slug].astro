---
import Layout from "../../layouts/Layout.astro";
import SmartImage from "../../components/SmartImage.astro";

import { client } from "../../lib/sanity";
import { urlFor } from "../../lib/sanity";

const allowedCategories = ["opera", "film", "commercials"];

export async function getStaticPaths() {
  const allowed = ["opera", "film", "commercials"];

  const rows = await client.fetch(`
    *[_type == "project" && defined(slug.current) && defined(category)]{
      category,
      "slug": slug.current
    }
  `);

  return rows
    .filter((r) => allowed.includes(r.category) && r.slug)
    .map((r) => ({ params: { category: r.category, slug: r.slug } }));
}

const { category, slug } = Astro.params;

if (!category || !allowedCategories.includes(category)) {
  throw new Error(`Invalid category: ${category}`);
}

const project = await client.fetch(
  `
  *[_type == "project" && category == $category && slug.current == $slug][0]{
    title,
    caption,
    director,
    award,
    placeAndYear,
    trailerLink,

    coverImage{
      ...,
      asset,
      "assetDoc": asset->{
        metadata{
          dimensions{ width, height },
          lqip
        }
      }
    },

    images[]{
      caption,
      ...,
      asset,
      "assetDoc": asset->{
        metadata{
          dimensions{ width, height },
          lqip
        }
      }
    }
  }
  `,
  { category, slug }
);

const title = project?.title ?? "Untitled";
const director = project?.director ?? "";
const award = project?.award ?? "";
const placeAndYear = project?.placeAndYear ?? "";
const trailerLink = project?.trailerLink ?? "";

// Next project (same ordering as your sidebar)
const siblings = await client.fetch(
  `*[_type == "project" && category == $category && defined(slug.current)]
    | order(orderRank asc, year desc, title asc){
      "slug": slug.current
    }`,
  { category }
);

const idx = siblings.findIndex((p) => p.slug === slug);
const nextSlug =
  idx >= 0 && siblings.length > 0 ? siblings[(idx + 1) % siblings.length].slug : null;
const nextHref = nextSlug ? `/${category}/${nextSlug}` : null;

const safeImageUrl = (img) => {
  try {
    return img?.asset?._ref ? urlFor(img).width(2000).auto("format").url() : null;
  } catch {
    return null;
  }
};

const coverUrl = safeImageUrl(project?.coverImage);
const coverMeta = project?.coverImage?.assetDoc?.metadata?.dimensions;
const coverLqip = project?.coverImage?.assetDoc?.metadata?.lqip ?? null;

const imageItems = [
  ...(coverUrl && coverMeta?.width && coverMeta?.height
    ? [
        {
          type: "image",
          src: coverUrl,
          caption: null,
          w: coverMeta.width,
          h: coverMeta.height,
          lqip: coverLqip,
          key: "cover",
          orientation:
            coverMeta.height > coverMeta.width
              ? "portrait"
              : coverMeta.height < coverMeta.width
                ? "landscape"
                : "square",
        },
      ]
    : []),

  ...(project?.images ?? [])
    .map((img, idx) => {
      const meta = img?.assetDoc?.metadata?.dimensions;
      if (!meta?.width || !meta?.height) return null;

      const src = safeImageUrl(img);
      if (!src) return null;

      const orientation =
        meta.height > meta.width
          ? "portrait"
          : meta.height < meta.width
            ? "landscape"
            : "square";

      return {
        type: "image",
        src,
        caption: img?.caption ?? null,
        w: meta.width,
        h: meta.height,
        lqip: img?.assetDoc?.metadata?.lqip ?? null,
        key: `img-${idx}`,
        orientation,
      };
    })
    .filter(Boolean),
];

const items = project
  ? [
      award
        ? { type: "title-award", key: "title-award" }
        : { type: "title-basic", key: "title-basic" },
      ...imageItems,
      { type: "footer-nav", key: "footer-nav" }, // ✅ last snap item
    ]
  : [];

const repeated = items;

const sectionLabel =
  category === "film" ? "Film" : category === "opera" ? "Opera" : "Commercials";
---

<Layout title={project ? `${title} — ${sectionLabel}` : `${sectionLabel} — Not found`}>
  {project ? (
    <div class="gallery-wrapper">
      <section class="grid" data-snap="1">
        {repeated.map((item, i) => (
          <div class="snap-item" data-idx={i}>
            {item.type === "title-award" ? (
              <header class="title-card">
                <div class="left">
                  <h1 class="title">{title}</h1>
                  {director && <p>{director}</p>}
                  {placeAndYear && <p>{placeAndYear}</p>}
                </div>
                <div class="right">
                  {award && <p class="award">{award}</p>}
                  {trailerLink && (
                    <a href={trailerLink} target="_blank" rel="noopener noreferrer">
                      Trailer<span class="arrow">↗</span>
                    </a>
                  )}
                </div>
              </header>
            ) : item.type === "title-basic" ? (
              <header class="title-card">
                <div class="left">
                  <h1 class="title">{title}</h1>
                  {director && <p>{director}</p>}
                </div>
                <div class="right">
                  {placeAndYear && <p>{placeAndYear}</p>}
                  {trailerLink && (
                    <a href={trailerLink} target="_blank" rel="noopener noreferrer">
                      Trailer<span class="arrow">↗</span>
                    </a>
                  )}
                </div>
              </header>
            ) : item.type === "footer-nav" ? (
              <footer class="title-card footer-card" aria-label="Gallery navigation">
                <div class="left">
                  <button type="button" class="nav-btn" data-nav="up">
                    Up<span class="arrow">↑</span>
                  </button>
                </div>

                <div class="right">
                  {nextHref ? (
                    <a class="nav-btn" href={nextHref}>
                      Next<span class="arrow">→</span>
                    </a>
                  ) : (
                    <span class="nav-btn is-disabled" aria-disabled="true">
                      Next<span class="arrow">→</span>
                    </span>
                  )}
                </div>
              </footer>
            ) : (
              <figure class={`figure ${item.orientation}`}>
                <SmartImage
                  srcUrl={item.src}
                  alt={title}
                  width={item.w}
                  height={item.h}
                  lqip={item.lqip}
                  loading={i === 1 ? "eager" : "lazy"} /* eager-load first image after title */
                  fit="cover"
                  bg="#fff"
                />
                {item.caption && <figcaption class="img-caption">{item.caption}</figcaption>}
              </figure>
            )}
          </div>
        ))}
      </section>
    </div>
  ) : (
    <article class="not-found">
      <h1>Project not found</h1>
      <p>
        We couldn’t find a {sectionLabel.toLowerCase()} project for slug: <code>{slug}</code>
      </p>
      <p>
        <a href={`/${category}`}>Back to {sectionLabel}</a>
      </p>
    </article>
  )}
</Layout>

<script is:inline>
  function initProjectSnap() {
    document.querySelectorAll('[data-snap="1"]').forEach((grid) => {
      if (grid.dataset.snapInited === "1") return;
      grid.dataset.snapInited = "1";

      // fade
      grid.dataset.ready = "0";

      // prevent snap fighting initial scroll
      const prevSnap = grid.style.scrollSnapType;
      grid.style.scrollSnapType = "none";
      grid.scrollTop = 0;

      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          grid.style.scrollSnapType = prevSnap || "";
          grid.dataset.ready = "1";
        });
      });
    });
  }

  function bindFooterNav() {
    const grid = document.querySelector('[data-snap="1"]');
    if (!grid) return;

    const footer = grid.querySelector(".footer-card");
    if (!footer || footer.dataset.bound === "1") return;
    footer.dataset.bound = "1";

    const upBtn = footer.querySelector('[data-nav="up"]');
    if (!upBtn) return;

    upBtn.addEventListener("click", () => {
      const prevSnap = grid.style.scrollSnapType;
      grid.style.scrollSnapType = "none";
      grid.scrollTo({ top: 0, behavior: "smooth" });

      // restore snap after scroll starts
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          grid.style.scrollSnapType = prevSnap || "";
        });
      });
    });
  }

  document.addEventListener("astro:page-load", () => {
    initProjectSnap();
    bindFooterNav();
  });

  document.addEventListener("astro:after-swap", () => {
    initProjectSnap();
    bindFooterNav();
  });

  // fallback
  initProjectSnap();
  bindFooterNav();
</script>

<style lang="scss">
  .gallery-wrapper {
    position: fixed;
    inset: 0;
    left: var(--content-left);
    width: var(--content-width);
    overflow: hidden;
  }

  .grid {
    height: 100%;
    scrollbar-width: none;
    overflow-y: auto;
    display: flex;
    flex-direction: column;

    scroll-snap-type: y mandatory;
    overscroll-behavior: contain;
    scroll-behavior: auto;

    /* lets first/last items snap to center without “running out of space” */
    // padding-block: 50vh;
    // scroll-padding-block: 50vh;
  }

  .snap-item {
    scroll-snap-align: center; /* ✅ snap in the middle */
    scroll-snap-stop: always;
    display: flex;
    align-items: center;
    padding-block: var(--lh);
  }

  .title-card {
    width: 100%;
    display: flex;
    gap: 0.5rem;

    .award {
      color: var(--gray);
    }

    .left,
    .right {
      width: 50%;
    }
  }


  .nav-btn {
    border: 0;
    background: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    color: inherit;
    font: inherit;
    text-decoration: none;
  }

  .nav-btn.is-disabled {
    opacity: 0.5;
    cursor: default;
    pointer-events: none;
  }

  .nav-btn:hover {
    color: #000;
  }

  /* lift arrows slightly above baseline */
  .arrow {
    display: inline-block;
    margin-left: 2px;
    font-size: 0.9em;
    line-height: 1;
    transform: translateY(-0.15em);
  }

  .figure {
    margin: 0;
    width: 100%;
  }

  .figure :global(.smart-media) {
    max-width: 100%;
    max-height: 90vh;
    width: auto;
    height: auto;
  }

  .figure :global(.smart-media[data-fit="contain"]) {
    width: auto;
    height: auto;
  }

  .figure.portrait :global(.smart-media) {
    max-width: 60%;
    max-height: 90vh;
  }

  .img-caption {
    margin-top: 0.5rem;
  }

  .not-found {
    padding-left: var(--content-left);
    width: var(--content-width);
  }

  @media (max-width: 768px) {
    .gallery-wrapper {
      left: var(--content-left);
      width: var(--content-width);
    }

    .grid {
      padding-top: calc(var(--lh) * 2);
    }

    .figure.portrait :global(.smart-media) {
      max-width: 100%;
    }

     .title-card {
    flex-direction: column;
    gap: 0.25rem; /* tighter on mobile */
    align-items: flex-start;
  }

  .title-card .left,
  .title-card .right {
    width: 100%;
  }

  /* optional: keep Trailer on its own line */
  .title-card .right a {
    display: inline-block;
    margin-top: 0.25rem;
  }
  }
</style>
